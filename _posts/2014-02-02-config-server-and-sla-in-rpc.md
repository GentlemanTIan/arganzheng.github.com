---
title: Config Server和SLA在RPC中的作用
layout: post
---


## 背景

在分布式系统中，经常会遇到这样的业务场景：

1. 查找远程服务的地址
2. 查找资源地址（如mc，redis等）
3. 访问远程服务时，获取超时时间、Load balance策略、HA策略等配置

当系统规模较小时，地址信息和配置信息可以保存在本地的文件系统中，以达到简单高效的目的。但是随着系统的壮大和服务器数量的增加，配置和地址信息的变更可能需要重启大量的服务器，这将会是十分“重量级”的操作。而这就是Config Service所要解决的问题。


## Config Service

Config Service是集配置服务和命名服务于一身的基础服务。它将地址信息和配置信息集中管理在云端，并且提供实时的变更通知。最常见的使用方是RPC服务。原则上来说，系统中发生的每一次远程调用，都要经过配置中心(或者本地agent)来寻址；系统中每一处的配置，都要从配置中心(或者本地agent)获取。因此，如果把分布式系统比喻为一张网的话，那么配置中心就处于这张网的中心。


## 实现

对外接口来看，配置中心其实就是如下两个功能的结合：

1. key-value 配置信息存储
2. pub-sub 配置信息变更推送

一般来说，功能1的实现方式各个组件基本都是一致的。不同可能在于key的约定以及服务的注册和摘除机制。
功能2的实现，基本也是本地agent+消息通知机制。

比如阿里的dubbo，key是接口的 全路径名 + 版本号，返回的value是服务提供方的`[<IP, Port>]`列表。然后由客户端进行负载均衡。
而腾讯的L5，key是SID（由模块ID和命令字ID组成），返回的value同样是服务提供方的`[<IP, Port>]`列表。然后由客户端进行负载均衡。


## Config Service in RPC

话说现在大多数企业还是习惯把配置信息存放在本地配置文件中，因为配置信息基本上是比较静态的。但是地址信息就相对动态多了，因为服务的线性拓展和负载均衡是很常见的，所以一在RPC框架中，基本上会引入Config Service提供服务的注册和查询服务。

不过笔者在实践中发现，在RPC中，Config Service仅仅提供地址服务是不够的，因为各个服务的SLA（Service Level Agreement）各不相同，而这个信息对于负载均衡非常重要，这些信息包括 超时时间、失败容忍度、频率限制、自动服务降级或者手动关闭，QoS，读写接口等等。这样，客户端可以根据这些信息进行更好的Load Balance和Invoke。其实现在API元数据已经逐渐承当了这部分角色，配合Config Service的地址服务，能够更好进行RPC调用。



