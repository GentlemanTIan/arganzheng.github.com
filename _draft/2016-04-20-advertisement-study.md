---
title: 广告系统学习
layout: post
catalog: true
---


问题
----

1、每个广告的点击扣费金额是统一的吗？应该是不一样的，所以有扣费策略。
2、用户点击跳转需要在我们这里登记(URL重定向)，如果不就近部署影响用户体验，另外，如果就近部署，日志可能分散在各个机房，如何实时的获取日志进行扣费？
3、点击URL需要加密，避免伪造。
4、如何保证扣费请求不重不丢， 精准扣费？
5、预算信息（账户余额，账户预算、计划预算、周预算、日预算）和扣费策略(一次点击多少钱)是在计费系统处理吗？还是计费系统只是发送计费事件给投放系统（订阅），让投放系统扣除余额？
	* 如果是前者，那么需要将投放系统的预算金额（变更）还有广告扣费策略同步到计费系统来
6、用户预算超过之后需要通知检索端把广告下线掉。所以这里计费模块或者投放系统跟检索系统有一个交互。具体是哪个系统发送下线通知，由知道预算余额的系统决定。如果用户下线广告，也需要通知检索断下线，所以这里推荐是由投放系统扣费并且通知。
7、如何支持各种广告收费类型：CPC, CPM, CPT，etc.
	* CPM类型的计费有如下特点：
		* 价格精度小：单条展现价格远小于1分，远低于财务库精度
		* 展现量大：单个产品线展现量上亿，直接对单条计费耗费资源
		* 统计报表非常不准确
		* 解决方案
			* 合并展示日志成CPM计费日志。
			* 扣费请求中对合并价格取整数分
 			* 不足1分价格参与下次累积合并
 			* dump不足1分钱数据
	* 有些计费类型是后付费类型，如CPS, CPL。
8、防作弊模块如何实现？

目前计费会在内存中保存了连续两天的点击日志的路由和序列号信息用于去重，而不仅是保存当前处理的最大序列号。由于路由和序列号信息并没有在点击日志里去除，所以日志乱序造成了同一个路由下的序列号到达计费后不保证是严格递增的，但并没有对计费的去重功能有影响，保证了点击日志能够在计费不重不丢地被处理。


对于凤巢这样的商业系统而言，有两条至关重要的日志数据流，一条是展现数据流，承载的是用户流量，来源于线上的ASP机器；而另一条是点击数据流，承载的是计费流量，来源于线上的RCV机器。特别是点击数据流，它处理的时效性影响着百度的收入，能够近实时的反馈广告主的预算消费等多维度的统计数据，能够使广告主及时地知道调整投放策略后的效果。

随着凤巢业务的高速迭代发展，点击串膨胀的问题也越来越凸显，其中主要原因是由点击串中的k域引起。根据前期调研，K域的字段个数已经到了为35个：其中有20个字段正在被上述下游使用，其余的15个字段主要用于线下统计等用途或者早期、策略实验需求，涉及的团队高达10个以上，包括Anti、计费、Model，Uflow，Edata等等：而随着业务的发展，相关的下游也会持续引入对K域字段的使用。

目前展现数据流已经包含点击串K域所有的内容，但是由于工程上的限制导致只能将将展现流已有的信息重新带到点击串中。这样的处理方式会带来一系列的问题：一来点击串中带来额外过多的数据会增大响应延迟和降低用户体验，这个问题在无线流量上尤为突出；二来这种方式可扩展性不强，点击URL天然有长度限制，限制了我们能够带的数据量的大小。

因此，目前在点击串中添加K域字段的需求之中，只有非常强必要的需求才会被检索端所接受，比如实时点击反作弊所需要的字段；其他的一般都是建议采取离线Join展现数据流的方式来解决，但是这也无形中增加了日志使用方额外的开发成本和计算成本。

与此同时，凤巢的反作弊系统经过大禹一期和二期的演变后，展现和点击的反作弊都已经迁移到大禹平台。点击和展现的底层依赖系统一致后，为点击保护、PastSpam策略、点击参考展现等功能的实现提供了技术上的保证。

为了减少用户搜索展示页面的大小，预期我们将在TM流式计算框架的基础上采用凤巢点击流实时从展现数据流获取K域数据的方式来解决，减少点击串中非必要数据的占比。此外，多条数据流的实时Join问题也是流式计算领域一个普适的问题，在公司的各个产品线都有类似的需求，比如PS等等。

因此我们认为建立一个通用的支持大时间窗口的多流实时Join平台是一个必不可少的事情，作为凤巢日志Log Pipe Line重要一环，除了能够彻底解决凤巢点击串膨胀带来的用户体验差和扩展性差问题，同时可以方便后续支持反作弊策略和各个日志下游补全数据需求，也能够产出通用的解决大时间窗口的多流实时Join难题的技术方案。


1. RCV是什么的缩写？职责是什么？貌似是点击日志接收和解密？
2. 点击日志怎么来的？是拉取还是推送？(跨机房问题)
3. 广告的跳转(302)是在RCV这里处理的？还是在上游(BFE)
4. RCV的上游必须是BFE吗？
5. 反作弊系统就是大禹系统吗？是RCV的必然下游吗？可以不走吗？
6. 怎么接入：步骤与成本
	* 点击url的构造
	* 计费rpc服务的搭建（非必须）
	* 联调注意以及其他注意点来说明
7. 物料如果不是标准物料能不能走RCV？不是竞价计费方式有没有问题？
8. CK域：鼠标点击和用户行为信息，看到是必填的？可以随便填写吗？
9. 只支持CPC吗?对于CPM、CPA可以支持吗？


2、 接入前注意点
接入方接入anti反作弊需构造anti统一格式的点击url，点击url加密需使用实时密钥中心enc center实时分发的密钥，此时需向enc center提供接入方检索端机器ip地址和端口号，联系人:王艳艳，默认密钥需要找ANTI确认
(enc的代码路径如下：app/ecom/shifen/sf-enc，如果没有权限，需要先申请，使用过程中请依赖最新的tag)
anti关注接入方的广告主信息，主要为：广告主是否为凤巢广告主，是否为网盟广告主等，如果是，需要及时周知
接入方需确定点击url前缀，格式为:http://www.baidu.com/xxx.php,其中xxx红色部分需接入方确定，并知晓BFE，BEF需修改配置，增加该前缀的点击转发到anti-rcv，联系人:罗蛟,陈韬(pc),liujunling02（wise）注：新产品线统一使用other.php前缀(如果不是other.php，则需要向baiduHD ，百度框，无线百度浏览器备案，加入其预加载黑名单)
接入方的点击refer可能非来自baidu.com，因anti有refer白名单的策略，因此，需提前向anti知晓接入方的合法refer取值。
接入方需联系计费rd（接口人:储大为，谢磊），确定和计费端的ci域和cj字段接口，并邮件周知
接入方需提供给anti bvs ip和端口，该ip和端口对应接入方期望anti发往的下游，如果直接接往计费，则不需关注。（联系人：接入方op）



接入百度一站式计费中心要求和步骤
---------------------------

1. CPC和CPA：BFE => rcv-anti(杨佳学，dsend) => 计费中心(姚鹏辉) => 预算控制(budget-server：王晓旭) => 财务平台(孟杰，bgt-server直接操作财务DB)
																			   => 检索端(订阅budget-server消息)
2. CPM: 展示日志(检索端，最好是PB日志，bigpipe) => [CPM反作弊] => CPM计费中心(储大为) => 预算控制(budget-server：王晓旭）=> 财务平台(孟杰，bgt-server直接操作财务DB)
																		 	=> 检索端(订阅budget-server消息)
3. CPT: 没有对接的上游系统，业务自己对接，按天扣费
	1. 业务方一天向计费中心发一次扣费请求
	2. 需要找财务平台冻结资金

**NOTES**

1. 要接入商业计费系统，必须使用百度统一账户(财务扣款)
2. 要接入商业计费系统，必须构造符合格式的URL(i, j, k域)
3. CPM反作弊这块现在没有通用组建服务，需要自己开发，走大禹/Remora2，已经有内建的算法，业务只需要实现：1. （日志）特征解析；2. 参数选取；预计一周左右可以完成。


BDG 图片变现计费方案
------------------

Hi all, 经过今天进一步的沟通，对图片变现计费需求做了进一步的明确，这里跟大家同步一下。

首先，来自于多酷的游戏app，由多酷跟广告主（游戏开发者）进行计费，我们图搜作为多酷的一个流量渠道来源，根据流量渠道id(打入渠道包中)，进行结算分成（分成比例事先谈好固定）。也就是这块不需要我们做CPS计费，我们只需要做一个倒流流量的统计，方便跟多酷多账（如果有必要的话）。

这样之后，其实目前比较急切的计费需求就是车险的明投了。从需求层面来看，凤巢的一站式计费系统是可以满足我们的计费需求，我们优先考虑接入他们系统。接入方案如下：

内部模块
	
* 广告商业平台
	* 物料管理
	* 账户 (UC账号)
	* 资金管理 (账户平台)
	* 统计报表 (UDW?)
* 检索端
	* 检索
	* 点击价格计算
	* 构造符合格式的点击URL (i, j, k域，ck域)，加密编码
	* 订阅buget-server的上下线消息，做广告上下线处理
	* 前端FE，需要展示表单样式的广告
* 表单提交处理模块
	* 处理查询请求（如费率计算等）
	* 将表单信息异步推送给广告主（可能通过API联调）
* 查询点击计费处理
	* CPC计费: 从查询URL中抽取出需要的字段，拼装成符合计费中心格式的点击URL (i, j, k域，ck域)，加密编码，发送给计费中心进行扣款（anti?）
	* CPL计费: 如果查询的表单中有电话号码，则按照CPL计费。


外部模块

* 账户中心（UC账户中心）
* 财务平台
* rcv-anti模块
* [计费中心]
* [预算控制]


说明

1、广告商业平台这块，车险 这块可以考虑接入 寻客 的物料平台，他们的物料格式跟我们很类似。他们的产品负责人是邵杰开，开发是李文伟。除了广告的投放，表单的提交处理（后端计算逻辑，比如费率之类的）以及跟广告主系统的打通，都已经是现成的。
2、红色部分是计费需要实现。
3、带[]的外部模块表示不需要直接对接（比如 rcv-anti => 计费中心 => 预算控制(budget-server) => 财务平台 这块其实是标准的计费上下流，我们只需要直接对接rcv-anti即可。），出问题的时候才需要沟通这些模块。
4、了解到车险明投的CPL计费是指留下电话号码的点击查询。这块没法直接接入rcv-anti，需要自己接收CPL查询点击，然后构造CPC点击发送给计费中心扣款。


rcv-anti接入说明
---------------

rcv所需点击url构造的格式为：

Pc: http://www.baidu.com/xxxx.php? url=iii.jjjj.kkk&ck=xxx&us=xxx
Wise: http://m.baidu.com/xxxx.php? url=iii.jjjj.kkk&ck=xxx&us=xxx

其中：

1. 点击url的格式包括url前缀，i域，j域，k域，ck域和us域
2. Pc和wise的url前缀存在不同，其他相同
3. xxx.php为不同产品线的前缀标识，如秋实为mobads.php,知心为zhixin.php等。前缀需由接入方确定，并且联系bfe进行映射添加，具体需联系anti-rd 杨佳学
4. 点击url在j域中封装的跳转url，rcv会对其进行前缀检查，如检验前缀必须为 http://,https://等，因此跳转url如果有特殊前缀，需向anti说明。
5. i域存放计费业务需要关注的字段。比如帐户层级信息，cost（需要扣多少钱），展现时间、点击时间等重要字段。 ，接入方需联系计费rd（接口人:储大为，谢磊），确定和计费端的ci域字段接口，并邮件周知。
6. j域主要包含跳转URL、计费名。
7. k域主要包含检索词
8. ck域是反作弊相关字段，包含鼠标点击和用户行为信息，anti会提供JS SDK。
9. us字段是扩展字段，接入方如果有信息在i, j, k和ck域不能完全表达，则可将信息放入us域中，us域不能使用的特殊字符”,=&”,且限长255字节。


具体展开的话各个域的字段如下：

**i域**

	typedef struct _rcv_s_t {
	    uint32_t s1;       
	    uint32_t s2;  
	} rcv_s_t;
	typedef struct _rcv_mac_t
	{
	    uint32_t mac[4];
	    uint32_t key;       
	} rcv_mac_t;
	typedef struct _rcv_fc_url_i_t {      
	    unsigned char version; // 值固定为3
	    unsigned char reserved; // 值由anti确定
	    uint16_t check_sum; // 校验码
	    uint32_t dtime; // 展现时间
	    uint64_t winfoid; // 广告id，保证全局唯一
	    uint64_t descid; // 创意id默认填0
	    uint32_t unitid; // 推广单元
	    uint32_t price; // 点击价格，对应shifen url的price,范围[10,99999],默认值不能填0
	    uint32_t bid; // 竞价价格，对应shifen url的bid，范围[1,99999],默认值不能填0
	    uint32_t rank; // 排名
	    uint32_t userid; // 用户id
	    uint32_t wordid; // 字面ID
	    uint32_t planid; // 推广计划 对应shifen url的wgrpid
	    uint32_t cmatch; // 投放频道，默认填0
	    uint32_t wmatch; // (0, 1, 2, 15, 31, 63, 20),默认填0
	    uint32_t dipaddr; // 展现IP,通过inet_pton从点分格式转换，默认填0,填默认值需要通知anti
	    uint32_t drate; // 展现系数, 默认填0
	    rcv_s_t svalue; // 检索唯一ID
	    rcv_mac_t mac; // 唯一签名
	} rcv_fc_url_i_t;


**j域**

j值包括跳转URL（e）、计费名（n）和CRC校验码（crc），采用如下的存储方式：
“e=url\0n=cntname\0crc=2727\0”
即每个参数由名字、等于号和值组成，尾部有’\0’分割，值不做任何特殊处理，每一部分后的第一个等号之后皆为值。

j值会经过压缩、base64编码。

CRC校验码为了保证j域完整性，它的生成、校验，和IM的rcv url中K域的CRC算法保持一致（对crc字段前的字符串进行标准16位crc校验，和i域check_sum的算法相同）。

没有计费名需要在tn.baidu.com申请，不能不填。

**k域**

k值的格式定义和j值完全相同，但不执行压缩，它包括K域的排名（o）、检索词（q）、CRC校验码（crc）及其它一些系统定义的参数，k值会被传递到点击日志中。
“o=2\0q=query\0crc=2727\0”

注意：

如果k域中存在以下名称的字段anti会关注：

	ft 打印版式 ， 取值 1:极简版(wml)，2:iphone版(iphone)3:炫彩版(middle) 4:触屏版(big) 5:apad 6:mid 7:utouch
	nt 网络类型 ，取值0: 未知网络 1: wifi 2: 2G 3 :3 G  4: 4G
	os 操作系统id
	ph 手机机型id
	bw 浏览器id
	tradid 知心行业id
	q 检索词
	sz 屏幕分辨率
	is_wireless 是否为无线流量
	dev 设备类型 0未知设备，1为pc，2为手机，3为pad
	appid 用于计费

ft,nt,os,ph,bw,tradeid 必须保证其值为uint32类型
is_wireless，如果是无线流量，则必须包含该字段，且将is_wireless值填为1
如果新产品线中有含义类似的字段，请直接复用该字段名称
如果含义不一致，请不要和以上字段名称重复。
appid字段必填，否则可能影响计费

**ck域**

* anti可提供ck域生成参考代码和校验代码，具体可联系凤巢fe前端负责人咨询，联系人：陶煦天
* ck中生成的时间相关信息的单位都为ms
* 校验码x生成过程中需要的dtime字段，需经过（dtime%100+30）变换后再调用对应js代码，当前dtime为秒级别
* 除客户端不支持js，其余情况请求url均需携带ck


一站式计费服务平台接口文档
-----------------------

计费平台提供计费服务的rpc接口, 客户端调用rpc接口. 计费平台通过rpc服务提供高可靠、高吞吐的计费服务。采用公司的ubrpc(/public/ubrpc 1.3.12.0)搭建后端server, 使用idl描述接口。ubrpc客户端目前支持java(public/javalib/ubrpc-j), php(public/phplib/mcpackrpc), c++(/public/ubrpc)等客户端。

### 扣费请求IDL接口

	struct charge_request_t 
	{ 
        uint32_t appid ; // 产品线id， UC那边分配给每个产品线的id， 凤巢是4， 北斗是5， dan是29， 34是移动网盟.  

        uint32_t userid ; // 用户的userid  
 
        string machineid ; // 机器id，新产品线使用uint64_t的数字。反作弊使用路由， 7个层级，每个层级间用.分割，每个层级路由的取值范围: [0，255].  

        uint64_t serialnum ; // 序列号， 同一个appid下， machineid和 serialnum可以唯一确定一个点击  

        uint32_t chgtype; // 技术资金池扣费=1; 产品资金池扣费=2; 技术资金池补款=3； 产品资金池补款=4  
 
        string ci; // 比如凤巢北斗里面需要给下游输出的字段， 放入ci域， 计费将把ci域关注字段解析出来， 放入计费日志,编码方式：每个字段之间用|分割， key=value形式。   

        string cj = optional(); // 计费不关注字段放入cj域, 计费将直接输出cj域给下游， 建议可读性好、解析方便，增加字段直接从cj解析即可。这个字段主要是透传给下游。 增加字段，计费不需要升级。  

        string ck = optional(); // 保留字段  
 
        uint32_t cl = optional(); // 保留字段  

        uint64_t cm = optional(); // 保留字段  
	};  

字段中不允许出现制表符\t，会影响计费日志输出  
Ci、cj域中不能出现’|’ 字符，不要出现同key相同的字符串。  

	struct charge_response_t  
	{  

	   uint32_t retcode; //返回值0表示成功， 1表示空包错误， 2表示第errindex个点击格式错误(超长或者其它)，打包时需要踢出去。  

	   uint32_t errindex = optional(); //哪个位置的点击出的错， 从0开始， 当retcode表示2的时候才有效  
	};  



	service ChargeService
	{
	     void charge_rpc(charge_request_t req[], out charge_response_t res); 

	         //一次rpc请求，可以发送多个扣费请求， 至少一个请求。  

	         //返回值， 0表示扣费请求被接收到， 1表示出错， 需要重试， 直到成功  
	};  


例子：知心计费接入


ci域

	“tradeid=83|planid=10870397|unitid=243233445|winfoid=4290057771|descid=1027169659|wordid=6688679|price=191|bid=800|clktime=1371627115|disptime=1371627097”

cj域

	"rank=2|cmatch=29070|wmatch=63|dispip=222.187.46.192|drate=0|srchid=c95c585b372c29d5|cntname=Baidu|k=THLPSP21Yte5VsKYTh7buy-b5H610APETLwxTh78p1Ys0ZPdmM7GujYkn1TkPWcLnjbLP16kPjcs0ANYXgK-5HD0uy-b5HfvrfK-uAN1mv-b5HDsnWTkPWbvPHb0mvkGmvVxIZ-suHYk0ZK85HD0mLFW5HnznjDz"

输出的计费日志格式

	appid\t userid\t machineid\t serialnum\t chgtype\t cj \t  tradeid\t planid \t unitid \t winfoid\t descid \t wordid\t pirce\t bid\t clktime \t disptime \t chgtype \t  balance \t urate \t rrate\t orderrow

	"190     5590753 152.0.0.10.0.0.0        893     1     rank=7|cmatch=29070|wmatch=63|dispip=182.126.22.56|drate=0|srchid=a20a45c90cd66fcf|cntname=Baidu|k=THLPSP21Yte5VsKYTh7buy-b5H610APETLwxTh78p1Ys0ZPdmM7GujYkn1TkPWcLnWmYP1RsrHc40ANYXgK-5HD0uy-b5Hmz0ANbugPWpyfqnH0zPjbLPHT1n6KWUA-WpdqYXgK-5HD0TA3qnfKWThnqn1msn1c     83      10861862        243358157       4285120877      1024975732      6688679 0.88    0.98    2013-06-19 15:36:16     2013-06-19 15:34:24     2013-06-19 15:36:53     71209.89        0.00000000      0.74074067      62013"

